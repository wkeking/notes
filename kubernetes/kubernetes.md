# Kubernetes

## 核心概念

Kubernetes为了更好的管理应用的生命周期，将不同资源对象进行了进一步的操作抽象。使用Kubernetes实际上就是要掌握这些不同的抽象对象。

Kubernetes中每种对象都拥有一个对应的声明式API。对象包括三大属性：元数据（metadata）、规范（spec）和状态（status）。元数据是用来标识API对象的，每个对象都至少有3个元数据：namespace、name和uid；除此之外还有各种各样的标签labels用来标识和匹配不同的对象，例如用户可以用标签env来标识区分不同的服务部署环境，分别用env=dev、env=testing、env=production来标识开发、测试、生产的不同服务。规范描述了用户期望K8s集群中的分布式系统达到的理想状态（Desired State），例如用户可以通过复制控制器Replication Controller设置期望的Pod副本数为3；status描述了系统实际当前达到的状态（Status），例如系统当前实际的Pod副本数为2；那么复制控制器当前的程序逻辑就是自动启动新的Pod，争取达到副本数为3。通过这三个属性，用户可以定义让某个对象处于给定的状态（如多少Pod运行在哪些节点上）以及表现策略（如如何升级、容错），而无须关心具体的实现细节。

##资源抽象对象

Kubernetes对集群中的资源进行了不同级别的抽象，每个资源都是一个REST对象，通过API进行操作，通过json或yaml格式的模板文件进行定义。

### 基本资源抽象对象

#### 容器组（Pod）

在Kubernetes中，并不直接操作容器，最小的管理单位时容器组（Pod）。容器组由一个或多个容器组成，Kubernetes围绕容器组进行创建、调度、停止等生命周期管理。

同一个容器组中，各个容器共享命名空间（包括网络、IPC、文件系统等容器支持的命名空间）、cgroups限制和存储卷。这意味着同一个容器组中，各个应用可以很方便的相互进行访问，比如通过localhost地址进行网络访问，通过信号量和共享内存进行进程间通信等，类似经典场景中运行在同一个操作系统中的一组进程。可以简单的将一个Pod当作是一个抽象的虚拟机，里面运行若干个不同的进程（每个进程实际上就是一个容器）。

实现上，是先创建一个gcr.io/google_containers/pause容器，创建相关命名空间，然后创建Pod中的其他应用容器，并共享pause容器的命名空间。

组成容器组的若干容器往往是存在共同的应用目的，彼此关联十分紧密。可以说，容器组既保持了容器轻量解耦的特性，又提供了调度操作的便利性，在实践中提供了比单个容器更为灵活和更有意义的抽象。

容器组生命周期包括五种状态值：待定、运行、成功、失败、未知。

- 待定（Pending）：已经被系统接受，但容器镜像还未就绪；
- 运行（Running）：分配到节点，所有容器都被创建，至少一个容器在运行中；
- 成功（Succeeded）：所有容器都正常退出，不需要重启，任务完成；
- 失败（Failed）：所有容器都退出，至少一个容器是非正常退出；
- 未知（Unknown）：未知状态，例如所在节点无法汇报状态。


#### 服务（Service）

服务的提出，主要是要解决Pod地址可变的问题。由于Pod随时可能发生故障，并可能在其他节点上被重启，它的地址是不可能被固定的。因此，用一个服务来代表提供某一类功能（可以通过标签来筛选）的一些Pod，并分配不随Pod位置变化而改变的虚拟访问地址（Cluster IP）。

典型的情况，比如网站的后端服务，可能有多个Pod都运行了后端处理程序，他们可能组成一个服务。前端只需要通过服务的唯一虚拟地址来访问即可，而无须关心具体是访问到了哪个Pod。服务跟负载均衡器实现的功能很相似。

根据访问方式的不同，服务可以分为以下几种类型：

- ClusterIP：提供一个集群内部的地址，该地址只能在集群内部解析和访问。ClusterIP是默认的服务类型。
- NodePort：在每个集群节点上映射服务到一个静态的本地端口。从集群外部可以直接访问，并自动路由到内部自动创建的ClusterIP。
- LoadBalancer：使用外部的路由服务，自动路由访问到自动创建的NodePort和ClusterIP。
- ExternalName：将服务映射到externalName域指定的地址。

#### 存储卷（Volume）

存储卷即容器挂载的数据卷，跟Pod有一致的生命周期，Pod生存过程（包括重启）中，数据卷跟着存在；Pod退出，则数据卷跟着退出。

### 控制器抽象对象

#### 副本集（ReplicaSet）

#### 部署（Deployment）

#### 状态集（StatefulSet）

#### Daemon集（DaemonSet）

#### 任务（Job）

#### 横向Pod扩展器（Horizontal Pod Autoscaler，HPA）

#### 入口控制器（Ingress Controller）

### 管理资源相关的辅助概念

#### 标签（Label）

#### 选择器（Selector）

#### 注解（Annotation）

#### 秘密数据（Secret）

#### 名字（Name）

####命名空间（Namespace）

#### 持久化存储（PersistentVolume）

#### 资源限额（Resource Quotas）

#### 安全上下文（Security Context）

#### 服务账号（Service Accounts）



