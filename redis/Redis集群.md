# Redis集群

Redis集群式Redis提供的分布式数据库方案，集群通过分片(sharding)来进行数据共享，并提供复制和故障转移功能。

集群节点和单机服务器在数据库方面的一个区别是，节点只能使用0号数据库，而单机服务器则没有这一限制。

**注意：Redis需要开启的端口除了命令端口，还需要集群总线端口，命令端口和集群总线端口偏移量是固定的，始终为10000。6379命令端口的集群总线端口是16379。**

## 节点（node）

### 启动节点

一个节点就是一个运行在集群模式下的Redis服务器，Redis服务器在启动时回根据

``` redis
cluster-enabled yes
```

配置选项来决定是否开启集群模式。

节点会继续使用所有在单机模式中使用的服务器组件。

### 连接节点

一个Redis集群通常由多个节点组成，在刚开始的时候，每个节点都是相互独立的，他们都处于一个只包含自己的集群中，要组建一个真正可工作的集群，必须将各个独立的节点连接起来，构成一个包含多个节点的集群。

``` redis
CLUSTER MEET <ip> <port>
```

向一个节点node发送`CLUSTER MEET`命令，可以让node节点于ip和port所指定的节点进行握手(handshake)，当握手成功时，node节点就会将ip和port所指定的节点添加到node节点当前所在的集群中。

## 槽（slot）

Redis集群通过分片的方式来保存数据库中的键值对：集群的整个数据库被分为16384个槽，数据库中的每个键都属于这16384个槽的其中一个，集群中的每个节点可以处理0个或最多16384个槽。

当数据库中的16384个槽都有节点在处理时，集群处于上线状态（ok）；相反的，如果数据库中有任何一个槽没有得到处理，那么集群处于下线状态（fail）。

### 指派槽

``` redis
CLUSTER ADDSLOTS <slot> [slot ...]
```

命令接收一个或多个槽作为参数，并将所有输入的槽指派给接收该命令的节点负责。

每个节点不仅会记录自己负责的槽，还会将自己负责的槽信息发送给集群其他节点并记录其他节点负责的槽信息。

## 在集群中执行命令

对数据库中16384个槽都进行了指派之后，集群就会进入上线状态，这时客户端就可以向集群中的节点发送数据命令了。

当客户端向节点发送与数据库键有关的命令时，接收命令的节点会计算出命令要处理的数据库键属于哪个槽，并检查这个槽是否指派了自己：

- 如果键所在的槽正好就指派给了当前节点，那么节点直接执行这个命令。
- 如果键所在的槽并没有指派给当前节点，那么节点会向客户端返回一个MOVED错误，指引客户端转向至正确的节点，并再次发送之前想要执行的命令。

### 计算键属于哪个槽

``` redis
CLUSTER KEYSLOT <key>
```

Redis使用CRC16 & 16384来计算键的槽号，使用上述命令可以返回键对应的槽号。

### MOVED错误

当节点发现键所在的槽并非有自己负责处理的时候，节点就会向客户端返回一个MOVED错误，引导客户端转向至正在负责槽的节点。

`MOVED <slot> <ip>:<host>`

集群模式的redis-cli客户端在接收到MOVED错误时，会根据MOVED错误自动进行节点转向。单机模式的redis-cli客户端，会直接打印出MOVED错误。

### 重新分片

Redis集群的重新分片操作可以将任意数量已经指派给某个节点的槽改为指派给另一个系欸的那，并且相关槽所属的键值对也会从源节点被移动到目标节点。

重新分片的操作可以在线进行，在重新分片的过程中，集群不需要下线，并且源节点和目标节点都可以继续处理命令请求。

Redis集群管理在5.0之前的版本由`redis-trib`负责执行，5.0之后版本将管理命令集成到redis-cli命令中，使用`redis-cli --cluster help`查看命令。

### ASK错误

在进行重新分片期间，源节点向目标节点迁移一个槽的过程中，可能会出现属于被迁移槽的一部分键值对保存在源节点里面，而另一部分键值对则保存在目标节点里面。

当客户端向源节点发送一个与数据库键相关的命令，并且命令要处理的数据库键恰好就属于正在被迁移的槽时：

- 源节点会先在自己的数据库里面查找指定的键，如果找到的话，就直接执行客户端的命令。
- 如果源节点没有在自己的数据库里面找到指定的键，那么这个键有可能已经被迁移到了目标节点，源节点将向客户端返回一个ASK错误，指引客户端转向正在导入槽的目标节点，并再次发送之前想要执行的命令。

集群模式的redis-cli客户端在接收到ASK错误时，会根据ASK错误自动进行节点转向。单机模式的redis-cli客户端，会直接打印出ASK错误。

当客户端接收到ASK错误并转向至正在导入槽的节点时，客户端会先向节点发送一个ASKING命令，然后才重新发送想要执行的命令，这是因为如果客户端不发送ASKING命令，而直接发送想要执行的命令的话，那么客户端发送的命令将被节点拒绝执行，并返回MOVED错误。

### ASK错误和MOVED错误的区别

MOVED错误代表槽的负责权已经从一个节点转移到了另一个节点。

ASK错误只是两个节点在迁移槽的过程中使用的一种临时措施。

## 复制与故障转移

Redis集群中的节点分为主节点和从节点，其中主节点用于处理槽，而从节点则用于复制某个主节点，并在被复制的主节点下线时，代替下线主节点继续处理命令请求。

### 设置从节点

向一个节点发送命令：

``` redis
CLUSTER REPLICATE <node_id>
```

可以让接收命令的节点成为node_id的从节点，并开始对主节点进行复制。

### 故障检测

集群中的每个节点都会顶起的向集群中的其他节点发送PING消息，以此来检测对方是否在线，如果接收PING消息的节点没有在规定的时间内，向发送PING消息的节点返回PONG消息，那么发送PING消息的节点就会将接收PING消息的节点标记为疑似下线（probable PFAIL）。

集群中的各个节点会通过互相发送消息的方式来交换集群中各个节点的状态信息。

如果在一个集群里，半数以上负责处理槽的主节点都将某个主节点报告为疑似下线，那么这个这个主节点将被标记为下线（FAIL），将主节点标记为已下线的节点会向集群广播一条关于主节点FAIL消息，所有收到这条消息的节点都会立即将主节点标记为已下线。

### 故障转移

当一个从节点发现自己正在复制的主节点进入了已下线状态时，从节点将开始对下线主节点进行故障转移：

- 复制下线主节点的所有从节点里面，会有一个从节点被选中。
- 被选中的从节点会执行`SLAVEOF no one`命令，成为新主节点。
- 新的主节点会撤销所有对已下线主节点的槽指派，并将这些槽全部指派给自己。
- 新的主节点向集群广播一条PONG消息，这条PONG消息可以让集群中的其他节点立即知道这个节点已经由从节点变成了主节点，并且这个主节点已经接管了原本由已下线节点负责处理的槽。
- 新的主节点开始接收和自己负责处理的槽相关的命令请求，故障转移完成。











