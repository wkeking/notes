# Redis主从复制

Redis中，可以通过执行SLAVEOF命令或者设置slaveof选项，让一个服务器复制另一个服务器，被复制的服务器称为主服务器(master)，而对主服务器进行复制的称为从服务器(slave)。

Redis在2.8版本中优化了主从复制低效的问题，即2.8版本及之后的复制功能实现原理和过程发生了改变。

## 旧版复制功能的实现

Redis复制功能分为同步(sync)和命令传播(command propagate)两个操作：

### 同步

同步操作用于将从服务器的数据库状态更新为主服务器当前所处的数据库状态。

从服务器对主服务器的同步操作需要通过向主服务器发送SYNC命令来完成，SYNC命令的执行步骤：

1. 从服务器向主服务器发送SYNC命令
2. 收到SYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令。
3. 当主服务器BGSAVE命令执行完毕时，主服务器会将BGSAVE命令生成的RDB文件发送给从服务器，从服务器接受并载入RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态。
4. 主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器执行这些写命令，将自己的数据库状态更新至主服务器数据库当前所处的状态。

### 命令传播

命令传播操作用于在主服务器的数据库状态被修改，导致主从服务器的数据库状态不一致，主服务器会将自己执行的命令，发送给从服务器执行，让主从服务器数据库状态回到一致状态。

### 旧版复制功能的缺陷

SYNC命令是一个非常耗费资源的操作，主从服务器每次断线重复制的时候都会执行SYNC命令，从而占用大量的资源。

## 新版复制功能的实现

Redis从2.8版本开始，使用PSYNC命令代替SYNC命令来执行复制时的同步操作。

PSYNC命令具有完整重同步(full resynchronization)和部分重同步(partial resynchronization)两种模式：

### 完整重同步

完整重同步用于处理初次复制情况，执行步骤和SYNC命令的执行步骤基本一样，他们都是通过让主服务器创建并发送RDB文件，以及向从服务器发送保存在缓存区里面的命令来进行同步。

#### 无磁盘化复制

主服务器在内存中直接创建RDB文件，然后发送给从服务器，不再写入到磁盘。

```redis
repl-diskless-sync yes		//开启无磁盘化复制
repl-diskless-sync-delay 5	//等待5s后再开始复制，等更多slave重新连接过来
```

### 部分重同步

部分重同步功能由三个部分构成：

- 主服务器的复制偏移量(replication offset)和从服务器的复制偏移量

主服务器和从服务器会分别维护一个复制偏移量。主服务器每次向从服务器传播N个字节数据时，就将自己的复制偏移量值加上N。从服务器每次收到主服务器传来的N个字节数据时，就将自己的复制偏移量值加上N。

- 主服务器的复制积压缓冲区(replication backlog)

复制积压缓冲区是由主服务器维护的一个固定长度先进先出队列，默认大小为1MB。

当主服务器进行命令传播时，它不仅会将写命令发送给所有从服务器，还会将写命令入队到复制积压缓冲区，因此，主服务器的复制积压缓冲区里面会保存着一部分最近传播的命令，并且复制积压缓冲区会为队列中的每个字节记录相应的复制偏移量。

``` redis
repl-backlog-size	//复制积压缓冲区大小
```

复制积压缓冲区大小可以根据2 x 从服务器断线重连所需平均时间 x 主服务器平均每秒产生写命令数据量

- 服务器的运行ID(run ID)

每个Redis服务器，都会有自己运行ID，在服务器启动时自动生成，由40个随机的十六进制字符组成。

### 复制的实现

- 步骤一：设置主服务器的地址和端口

``` redis
slaveof <masterip> <masterport>
```

- 步骤二：建立套接字连接
- 步骤三：发送PING命令
- 步骤四：身份验证

``` redis
masterauth <master-password>	//连接主服务器的密码
requirepass foobared			//需要密码
```

如果从服务器设置了masterauth选项，那么进行身份验证，否则不进行身份验证。

- 步骤五：发送端口信息
- 步骤六：同步

从服务器向主服务器发送PSYNC命令，执行同步操作，并将自己的数据库更新至主服务器数据库当前所处的状态。

PSYNC命令的调用方式有两种：

1. 如果从服务器以前没有复制过任何主服务器，或者之前执行了SLAVEOF no one命令，那么从服务器将向主服务器发送PSYNC ？ -1命令，主动请求主服务器进行完整重同步。
2. 如果从服务器已经复制过某个主服务器，那么从服务器将向主服务器发送PSYNC <runid> <offset>命令，其中runid是上一次复制的主服务器的运行ID，而offset则是从服务器当前的复制偏移量。

根据情况，接收到PSYNC命令的主服务器会向从服务器返回三种回复：

1. +FULLRESYNC <runid> <offset>，表示主服务器与从服务器执行完整重同步操作
2. +CONTINUE，表示主服务器与从服务器执行部分重同步操作
3. -ERR，表示主服务器版本低于2.8版本，从服务器会发送SYNC进行同步

- 步骤七：命令传播

完成了同步之后，主服务器将自己执行的写命令发送给从服务器，保证主从服务器一致。

## 心跳检测

心跳检测在Redis2.8版本新增的，以前版本，即使命令在传播过程中丢失，主从服务器也不会注意到。

在命令传播阶段，从服务器默认会以每秒一次的频率，向主服务器发送命令：

``` redis
REPLCONF ACK <replication_offset>
```

发送REPLCONF ACK命令对于主从服务器有三个作用：

1. 检测主从服务器的网络连接状态
2. 辅助实现min-slaves选项
3. 检测命令丢失

### 检测主从服务器的网络连接状态

如果主服务器超过一秒钟没有收到从服务器发来的REPLCONF ACK命令，那么主服务器就知道主从服务器之间的连接出现问题了。

可以向主服务器发送INFO replication命令，在列出的从服务器列表lag一栏看到相应从服务器最后一次发送REPLCONF ACK命令距离现在过了多少秒。

### 辅助实现min-slaves选项

``` redis
min-slaves-to-write 3
min-slaves-max-lag 10
```

主服务器提供如上设置，那么在从服务器数量少于3个，或者三个从服务器的延迟(lag)值都大于等于10秒时，主服务器将拒绝执行写命令。

### 检测命令丢失

当从服务器向主服务器发送REPLCONF ACK命令时，主服务器发现从服务器发送的偏移量少于自己的偏移量，将根据从服务器的偏移量在复制缓冲积压区里面找到从服务器缺少的数据，并发送给从服务器。

注意，主服务器从服务器补发缺失数据操作的原理和部分重同步操作的原理非常相似，两个操作的区别在于，补发缺失数据操作在主服务器没有断线的情况下执行，而部分重同步操作在主从服务器断线重连后执行。