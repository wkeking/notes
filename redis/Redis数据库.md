# Redis数据库

## 服务器中的数据库

在初始化服务器的时候，程序会根据服务器状态的dbnum属性来决定应该创建多少个数据库。

dbnum属性的值由服务器配置` database `选项决定，默认情况下，该选项的值为16，所以Redis服务器默认会创建16个数据库。

## 切换数据库

每个Redis客户端都有自己的目标数据库，没当客户端执行数据库写命令或者数据库读命令时，目标数据库就会成为这些命令的操作对象。

默认情况下，Redis客户端的目标数据库为0号数据库。

``` redis
SELECT dbnum	//切换目标数据库
```

## 设置键的生存时间或过期时间

Redis有四个不同的命令可以用于设置键的生存时间（键可以存在多久）或过期时间（键什么时候会被删除）。

- ` EXPIRE <key> <ttl> `：命令用于将键key的生存时间设置为ttl秒
- ` PEXPIRE <key> <ttl> `：命令用于将键key的生存时间设置为ttl毫秒
- ` EXPIREAT <key> <timestamp> `：命令用于将键key的过期时间设置为timestamp所指的秒数时间戳
- ` PEXPIREAT <key> <timestamp> `：命令用于将键key的过期时间设置为timestamp所指的耗秒数时间戳
- ` TTL <key> `：接受一个带有生存时间或者过期时间的键，返回这个键的剩余秒数生存时间
- ` PTTL <key> `：接受一个带有生存时间或者过期时间的键，返回这个键的剩余耗秒数生存时间
- ` PERSIST <key> `：命令可以移除一个键的过期时间

## 过期键删除策略

- 定时删除：在设置键的过期时间的同时，创建一个定时器，让定时器在键的过期时间来临时，立即执行对键的删除操作。
- 惰性删除：放任键过期不管，但是每次从键空间中获取键时，都检查取得的键是否过期，如果过期的话，就删除该键；如果没有过期，就返回该键。
- 定期删除：每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键。

Redis服务器使用的是惰性删除和定期删除两种策略：通过配合使用这两种策略，服务器可以很好的在合理使用CPU事件和避免浪费内存空间之间取得平衡。

Redis内存淘汰策略：

``` redis
maxmemory-policy volatile-lru
```

- volatile-lru：从已设置过期时间的数据集中挑选最近最少使用的数据淘汰
- volatile-ttl：从已设置过期时间的数据集中挑选将要过期的数据淘汰
- volatile-random：从已设置过期时间的数据集中任意选择数据淘汰
- allkeys-lru：从数据集中挑选最近最少使用的数据淘汰
- allkeys-random：从数据集中任意选择数据淘汰
- no-enviction：禁止驱逐数据，新写入操作会报错

## AOF、RDB和复制功能对过期键的处理

### 生成RDB文件

在执行SAVE命令或者BGSAVE命令创建一个新的RDB文件时，程序会对数据库中的键进行检查，已过期的键不会被保存到新创建的RDB文件中。

### 载入RDB文件

- 如果服务器以主服务器模式运行，那么在载入RDB文件时，程序会对文件保存的键进行检查，过期的键会被忽略。
- 如果服务器以从服务器模式运行，那么在载入RDB文件时，文件中保存的所有键，不论是否过期，都会别载入到数据库中。不过，主从服务器在进行数据同步的时候，从服务器数据库会被清空，所以过期键对载入RDB的从服务器也不会造成影响。

### AOF文件写入

当服务器以AOF持久化模式运行，如果数据库中的某个键已经过期，但它还没有被惰性删除或者定期删除，那么AOF文件不会因为这个过期键而产生任何影响。

当过期键被惰性删除或者定期删除之后，程序会向AOF文件追加一条DEL命令，来显示的记录该键已被删除。

### AOF重写

在执行AOF重写的过程中，程序会对数据库中的键进行检查，已过期的键不会被保存到重写后的AOF文件中。

### 复制

- 主服务器在删除一个过期键之后，会显示的向所有从服务器发送一个DEL命令，告知从服务器删除这个过期键
- 从服务器在执行客户端发送的读命令时，即使碰到过期键也不会将过期键删除，而是继续像处理未过期的键一样来处理过期键
- 从服务器只有在接到主服务器发来的DEL命令之后，才会删除过期键