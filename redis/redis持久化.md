# Redis持久化

Redis持久化机制有两种：RDB快照、AOF日志。

## RDB

RDB持久化功能可以将Redis内存数据结构保存到磁盘中，避免数据意外丢失。

RDB持久化功能所生成的RDB文件是一个经过压缩的二进制文件，通过该文件可以还原生成RDB文件时的内存数据结构。

### RDB文件的创建

Redis有三种生成RDB文件的方式，其中两种命令方式，一种配置自动方式：

- 命令SAVE
- 命令BGSAVE
- 自动间隔性保存

#### 1.SAVE

SAVE命令会阻塞Redis服务器进程，直到RDB文件创建完毕为止，因为Redis是单线程程序，所以在服务器进程阻塞期间，服务器不能处理任何命令请求。

RDB文件IO将严重影响服务器性能，而且阻塞时间随着数据库内存数据的增多而增多。

#### 2.BGSAVE

BGSAVE命令会派生出一个子进程，然后由子进程负责创建RDB文件，服务器进程继续处理命令请求。

Redis 在持久化时会调用glibc的函数fork产生一个子进程，快照持久化完全交给子进程来处理，父进程继续处理客户端请求。子进程刚刚产生时，它和父进程共享内存里面的代码段和数据段。

子进程做数据持久化，它不会修改现有的内存数据结构，它只是对数据结构进行遍历读取，然后序列化写到磁盘中。但是父进程不一样，它必须持续服务客户端请求，然后对内存数据结构进行不间断的修改。

这个时候就会使用操作系统的COW(Copy On Write) 机制来进行数据段页面的分离。数据段是由很多操作系统的页面组合而成，当父进程对其中一个页面的数据进行修改时，会将被共享的页面复制一份分离出来，然后对这个复制的页面进行修改。这时子进程相应的页面是没有变化的，还是进程产生时那一瞬间的数据。

随着父进程修改操作的持续进行，越来越多的共享页面被分离出来，内存就会持续增长。但是也不会超过原有数据内存的 2 倍大小。

#### 3.自动间隔性保存

Redis允许用户通过设置服务器配置的save选项，让服务器每隔一段时间自动执行一次BGSAVE命令。可以通过save选项设置多个保存条件，但只要其中任意一个条件被满足，服务器就会执行BGSAVE命令。

```redis
save 900 1		//服务器在900秒之内，对数据库进行了至少1次修改
save 300 10		//服务器在300秒之内，对数据库进行了至少10次修改
save 60 10000	//服务器在60秒之内，对数据库进行了至少10000次修改
```

### RDB文件的载入

RDB文件的载入工作是在服务器启动时自动执行的，只要Redis服务器在启动时检测到RDB文件存在，并且AOF持久化功能处于关闭状态时，它就会自动载入RDB文件。

服务器在载入RDB文件期间，会一直处于阻塞状态，知道载入工作完成为止。









